<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget – Local‑First (Vanilla JS)</title>
  <style>
    :root{
      --brand:#ff7a00; /* header accent */
      --ink:#1f2937;
      --sub:#6b7280;
      --bg:#f8fafc;
      --card:#ffffff;
      --muted:#f1f5f9;
      --ok:#16a34a;
      --warn:#ea580c;
      --err:#b91c1c;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    header{
      position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--brand),#ffa733);
      color:white;padding:14px 18px;box-shadow:0 2px 6px rgba(0,0,0,.08);
      display:flex;align-items:center;gap:14px
    }
    header h1{font-size:18px;margin:0;font-weight:700}
    .pill{background:rgba(255,255,255,.16);padding:6px 10px;border-radius:999px}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-left:auto}
    .toolbar select,.toolbar button,.toolbar input[type="month"]{
      appearance:none;border:1px solid rgba(255,255,255,.5);background:rgba(255,255,255,.15);
      color:#fff;border-radius:8px;padding:6px 10px;backdrop-filter: blur(4px);
    }
    .toolbar button{cursor:pointer}

    main{padding:18px;max-width:1400px;margin:0 auto;}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{border:1px solid var(--border);background:var(--card);padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab[aria-selected="true"]{background:#111827;color:#fff;border-color:#111827}

    .grid{display:grid;grid-template-columns: 420px 1fr;gap:18px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:16px}
    .card .content{padding:12px 14px}

    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);padding:8px 8px;text-align:left}
    .table th{font-size:12px;color:var(--sub);font-weight:600}
    .table tfoot td{font-weight:700}
    /* Grouping / Collapse UI */
    .group-row td{background:var(--muted);font-weight:700}
    .group-row .toggle{border:0;background:transparent;cursor:pointer;margin-right:6px}

    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kpi div{background:var(--muted);padding:8px;border-radius:10px}
    .kpi strong{display:block;font-size:18px}

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 160px}
    input,select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:#fff}
    button.primary{background:var(--ink);color:#fff;border:0;padding:8px 12px;border-radius:10px;cursor:pointer}
    button.ghost{background:transparent;border:1px dashed var(--border);}

    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:18px}

    .list{max-height:320px;overflow:auto;border:1px solid var(--border);border-radius:10px}
    .list-item{display:flex;justify-content:space-between;gap:8px;padding:8px 10px;border-bottom:1px solid var(--border)}
    .list-item small{color:var(--sub)}

    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--muted)}
    .right{text-align:right}
    .success{color:var(--ok)}
    .danger{color:var(--err)}
    canvas{width:100%;height:360px;background:#fff;border:1px solid var(--border);border-radius:10px}

    .footer-note{color:var(--sub);font-size:12px;margin-top:10px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <h1>Budget for <span id="header-month"></span></h1>
    <span class="pill" id="leftover-pill">Left Over £0.00</span>

    <div class="toolbar">
      <input type="month" id="month-picker" />
      <button id="new-month" title="Create a new month from template or copy last month">New Month</button>
      <select id="open-month"></select>
      <button id="duplicate-month">Duplicate Prev</button>
      <button id="export-month">Export Month</button>
      <button id="export-year">Export Year</button>
      <button id="export-all">Export All</button>
      <label style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
        <span>Import</span>
        <input id="import-file" type="file" accept="application/json" style="display:none"/>
      </label>
    </div>
  </header>

  <main>
    <div class="tabs" role="tablist">
      <button class="tab" role="tab" id="tab-budget" aria-selected="true">Budget</button>
      <button class="tab" role="tab" id="tab-transactions" aria-selected="false">Transactions</button>
      <button class="tab" role="tab" id="tab-learning" aria-selected="false">Prediction Map</button>
    </div>

    <section id="panel-budget" role="tabpanel">
      <div class="grid">
        <div class="card">
          <h2>Money In</h2>
          <div class="content">
            <div class="row">
              <input id="income-name" placeholder="Income name e.g. Salary, Interest"/>
              <input id="income-amount" type="number" step="0.01" placeholder="Amount"/>
              <button class="primary" id="add-income">Add Income</button>
            </div>
            <div class="list" id="income-list"></div>
            <div class="kpi" style="margin-top:10px">
              <div><span>Total Income</span><strong id="total-income">£0.00</strong></div>
              <div><span>Income − Actual Expenses</span><strong id="leftover-actual">£0.00</strong></div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Overview</h2>
          <div class="content charts">
            <canvas id="bar-categories" height="360"></canvas>
            <div class="two-col">
              <div>
                <h3 style="margin:0 0 8px 0">Actual Split</h3>
                <canvas id="donut-actual" height="360"></canvas>
              </div>
              <div>
                <h3 style="margin:0 0 8px 0">Budget Split</h3>
                <canvas id="donut-budget" height="360"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:18px">
        <h2>Money Out – Categories</h2>
        <div class="content">
          <div class="row" style="margin-bottom:10px">
            <input id="cat-name" placeholder="Category name (e.g. Groceries)"/>
            <input id="cat-group" placeholder="Group (e.g. Food)"/>
            <input id="cat-budget" type="number" step="0.01" placeholder="Budget"/>
            <button class="primary" id="add-category">Add/Update Category<\/button>
            <button class="ghost" id="reset-template" title="Reset current month categories to default template">Template<\/button>
            <button class="ghost" id="collapse-all" title="Collapse all groups">Collapse All<\/button>
            <button class="ghost" id="expand-all" title="Expand all groups">Expand All<\/button>
          </div>

          <table class="table" id="category-table">
            <thead>
              <tr>
                <th>Group</th>
                <th>Category</th>
                <th class="right">Budget</th>
                <th class="right">Actual</th>
                <th class="right">Difference</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td><strong>Totals</strong></td>
                <td></td>
                <td class="right" id="tot-bud">£0.00</td>
                <td class="right" id="tot-act">£0.00</td>
                <td class="right" id="tot-diff">£0.00</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
          <div class="footer-note">Tip: Click a row to edit. Difference = Budget − Actual.</div>
        </div>
      </div>
    </section>

    <section id="panel-transactions" role="tabpanel" class="hidden">
      <div class="grid">
        <div class="card">
          <h2>Add Transaction</h2>
          <div class="content">
            <div class="row">
              <input id="tx-date" type="date" />
              <input id="tx-desc" placeholder="Description (e.g. Waitrose)" />
              <input id="tx-amt" type="number" step="0.01" placeholder="Amount (positive = spend)" />
              <select id="tx-cat"></select>
            </div>
            <div class="row">
              <button class="primary" id="add-tx">Add</button>
              <span id="predict-hint" class="badge">Prediction: –</span>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Expenditure per Category</h2>
          <div class="content">
            <canvas id="bar-percat" height="360"></canvas>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:18px">
        <h2>Monthly Transactions</h2>
        <div class="content">
          <div class="list" id="tx-list"></div>
        </div>
      </div>
    </section>

    <section id="panel-learning" role="tabpanel" class="hidden">
      <div class="card">
        <h2>Description → Category Map (auto‑learning)</h2>
        <div class="content">
          <p class="footer-note">The app learns from your transactions. It tokenises descriptions and builds a frequency map to predict categories. You can pin exact matches below.</p>
          <div class="row">
            <input id="learn-desc" placeholder="Exact description e.g. Waitrose"/>
            <select id="learn-cat"></select>
            <button class="primary" id="learn-add">Pin Mapping</button>
          </div>
          <div class="list" id="learn-list"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
  // ===== Utils
  const Utils = (()=>{
    const fmt = (n)=>`£${(n||0).toFixed(2)}`;
    const id = () => Math.random().toString(36).slice(2,9);
    const monthKey = (d)=>{
      if(typeof d === 'string') return d; // already key
      const dt = d || new Date();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      return `${dt.getFullYear()}-${m}`;
    };
    const groupBy = (arr, fn)=>arr.reduce((a,x)=>{const k=fn(x);(a[k]=a[k]||[]).push(x);return a;},{});
    const sum = (arr, fn=(x)=>x)=>arr.reduce((a,x)=>a+fn(x),0);
    const clone = (o)=>JSON.parse(JSON.stringify(o));
    return {fmt,id,monthKey,groupBy,sum,clone};
  })();

  // ===== Storage (localStorage) – closure encapsulation
  const Store = (()=>{
    const KEY = 'budget.local.v1';
    const load = ()=>{
      try{ return JSON.parse(localStorage.getItem(KEY)) || {version:1, months:{}, mapping:{exact:{}, tokens:{}}, ui:{collapsed:{}}}; }
      catch{ return {version:1, months:{}, mapping:{exact:{}, tokens:{}}, ui:{collapsed:{}}}; }
    };
    const save = (state)=>localStorage.setItem(KEY, JSON.stringify(state));
    const state = load();
    const getMonth = (mk)=> state.months[mk];
    const setMonth = (mk, data)=>{ state.months[mk]=data; save(state); };
    const allMonths = ()=> Object.keys(state.months).sort();
    const mapping = ()=> state.mapping;
    const setMapping = (m)=>{ state.mapping = m; save(state); };
    const exportMonths = (filterFn)=>{
      const months = {};
      for(const k of Object.keys(state.months)) if(!filterFn || filterFn(k)) months[k]=state.months[k];
      return {version:state.version, months, mapping: state.mapping};
    };
    const importData = (json)=>{
      const incoming = typeof json === 'string' ? JSON.parse(json) : json;
      if(!incoming || !incoming.months) return;
      state.version = incoming.version || state.version;
      state.mapping.exact = {...state.mapping.exact, ...(incoming.mapping?.exact||{})};
      for(const [k,v] of Object.entries(incoming.mapping?.tokens||{})){
        const cur = state.mapping.tokens[k] || {};
        for(const [cat,cnt] of Object.entries(v)) cur[cat] = (cur[cat]||0)+cnt;
        state.mapping.tokens[k] = cur;
      }
      for(const [mk,month] of Object.entries(incoming.months)) state.months[mk]=month; // last-write-wins
      save(state);
    };
    // Collapsed groups (UI state)
    const collapsedFor = (mk)=>{ state.ui = state.ui || {collapsed:{}}; state.ui.collapsed = state.ui.collapsed || {}; state.ui.collapsed[mk] = state.ui.collapsed[mk] || {}; return state.ui.collapsed[mk]; };
    const isCollapsed = (mk,g)=> !!collapsedFor(mk)[g];
    const setCollapsed = (mk,g,val)=>{ collapsedFor(mk)[g]=!!val; save(state); };
    const toggleCollapsed = (mk,g)=>{ setCollapsed(mk,g,!isCollapsed(mk,g)); };
    const setAllCollapsed = (mk, groups, val)=>{ const obj = collapsedFor(mk); (groups||[]).forEach(g=>obj[g]=!!val); save(state); };
    return {state,getMonth,setMonth,allMonths,mapping,setMapping,exportMonths,importData,collapsedFor,isCollapsed,setCollapsed,toggleCollapsed,setAllCollapsed};
  })();

  // ===== Charts (vanilla Canvas)
  const Charts = (()=>{
    const bar = (canvas, labels, series)=>{
      if(!canvas) return; const ctx = canvas.getContext('2d');
      const W = canvas.width = canvas.clientWidth*2; const H = canvas.height = canvas.clientHeight*2;
      ctx.clearRect(0,0,W,H); ctx.font = '24px system-ui'; ctx.fillStyle = '#111';
      const left=90, right=40, bottom=80, top=30; const plotW=W-left-right, plotH=H-top-bottom;
      const max = Math.max(1, ...series.flat());
      // axes
      ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(left,top); ctx.lineTo(left,H-bottom); ctx.lineTo(W-right,H-bottom); ctx.stroke();
      const n = labels.length; const groups = series.length; const band = plotW/n; const barW = Math.min(50,(band-20)/groups);
      const colors = ['#f59e0b','#0ea5e9','#10b981','#ef4444','#8b5cf6'];
      labels.forEach((lab,i)=>{
        const x0 = left + i*band + 10;
        series.forEach((s,g)=>{
          const val = s[i]||0; const h = (val/max)*plotH; const x = x0 + g*(barW+8); const y = H-bottom - h;
          ctx.fillStyle = colors[g%colors.length]; ctx.fillRect(x,y,barW,h);
        });
        ctx.save(); ctx.fillStyle = '#374151'; ctx.textAlign='center';
        ctx.translate(x0+band/2-10,H-bottom+28); ctx.rotate(-0.2); ctx.fillText(lab,0,0); ctx.restore();
      });
      // legend
      const names = ['Budget','Actual'];
      names.forEach((name,i)=>{ ctx.fillStyle = colors[i]; ctx.fillRect(left + i*160, 8, 28, 18); ctx.fillStyle='#111'; ctx.fillText(name, left + i*160 + 36, 24); });
    };

    const donut = (canvas, parts)=>{
      if(!canvas) return; const ctx = canvas.getContext('2d');
      const W = canvas.width = canvas.clientWidth*2; const H = canvas.height = canvas.clientHeight*2;
      ctx.clearRect(0,0,W,H);
      const cx=W/2, cy=H/2, r=Math.min(W,H)/3, r2=r*0.64; const total = Object.values(parts).reduce((a,b)=>a+b,0)||1;
      let start=-Math.PI/2; const colors=['#0ea5e9','#ef4444','#10b981','#f59e0b','#8b5cf6','#14b8a6','#e11d48','#84cc16','#06b6d4'];
      let i=0; for(const [k,v] of Object.entries(parts)){
        const ang = (v/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle = colors[i++%colors.length];
        ctx.arc(cx,cy,r,start,start+ang); ctx.closePath(); ctx.fill();
        // label
        const mid=start+ang/2; const lx=cx+Math.cos(mid)*(r+24); const ly=cy+Math.sin(mid)*(r+24);
        ctx.fillStyle='#111'; ctx.font='22px system-ui'; ctx.fillText(`${k}`, lx-10, ly);
        start += ang;
      }
      // hole
      ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,r2,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over';
      ctx.fillStyle='#111'; ctx.font='28px system-ui'; ctx.textAlign='center'; ctx.fillText('Budget',cx,cy+10);
    };

    return {bar,donut};
  })();

  // ===== Predictor (learn tokens)
  const Predictor = (()=>{
    const tokensOf = (s)=> (s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(Boolean);
    const predict = (desc, cats)=>{
      const map = Store.mapping();
      const exact = map.exact[desc?.trim().toLowerCase()];
      if(exact) return exact;
      const tok = tokensOf(desc);
      const scores = {};
      for(const t of tok){
        const counts = map.tokens[t];
        if(counts) for(const [cat,v] of Object.entries(counts)) scores[cat]=(scores[cat]||0)+v;
      }
      let best=null, bestScore=0; for(const [cat,score] of Object.entries(scores)) if(score>bestScore){best=cat;bestScore=score;}
      return best && cats.includes(best) ? best : '';
    };
    const learn = (desc, cat)=>{
      if(!desc||!cat) return; const map = Store.mapping();
      const key = desc.trim().toLowerCase();
      map.exact[key]=cat;
      for(const t of desc.toLowerCase().split(/\s+/).filter(Boolean)){
        const bag = map.tokens[t]||{}; bag[cat]=(bag[cat]||0)+1; map.tokens[t]=bag;
      }
      Store.setMapping(map);
    };
    return {predict,learn};
  })();

  // ===== Model for a Month
  const Model = (()=>{
    const emptyMonth = ()=>({
      incomes:[],
      categories:{}, // name -> {group,budget}
      transactions:[] // {id,date,desc,amount,category}
    });

    // Default categories template (based on the provided sheet)
    const template = ()=>{
      const t = emptyMonth();
      // Housing
      addCat(t,'Housing','Housing',1610.95);
      ;[['Rent',1217.19],['Shed Rent',8.30],['Council Tax',170.00],['Electricity',96.29],['Water',49.00],['Hot Water & Heating',30.00],['Internet',40.17]].forEach(([n,b])=>addCat(t,n,'Housing',b));
      // Food
      addCat(t,'Food','Food',1700.00); [['Groceries',1600.00],['Takeout',100.00]].forEach(([n,b])=>addCat(t,n,'Food',b));
      // Savings
      addCat(t,'Savings','Savings',300.00); [['JVB - £20 each',0],['Investing',0],['Saving',300.00]].forEach(([n,b])=>addCat(t,n,'Savings',b));
      // Subscriptions
      addCat(t,'Subscriptions','Subscriptions',204.56);
      ;[['Epidemic Sound',15.98],['Apple Music',24.95],['Amazon Prime',0],['Audible',8.99],['Burim Gym',0],['V&B Math Tutoring',0],['Apple iCloud',0],['Google Suite for nyoki.co.uk',14.40],['Amazon Photos',7.99],['Piano Lesson',0],['BioGaia',0],['Appliances Insurance',20.99],['WSJ',2.00],['Life Insurance',40.67],['Apple Care',33.43],['StockCharts',15.17],['ChatGPT',19.99]].forEach(([n,b])=>addCat(t,n,'Subscriptions',b));
      // Travel
      addCat(t,'Travel','Travel',577.01); [['Fuel',120.00],['Public Transport',35.00],['Parking',0],['Car Lease + Running Costs',336.05],['Car Insurance',85.96]].forEach(([n,b])=>addCat(t,n,'Travel',b));
      // Loan
      addCat(t,'Loan','Loan',10.52); [['Ora e Njomzes',10.52]].forEach(([n,b])=>addCat(t,n,'Loan',b));
      // Mobile Phones
      addCat(t,'Mobile Phones','Mobile Phones',167.74);
      ;[['Mobile Burim',21.38],['Mobile Njomza',17.21],['Mobile Jeta',15.74],['Mobile Emin',17.21],['Mobile Vala',12.68],['Mobile Bleta',12.68],['Apple Watch',14.46],['Mobili i Jetes',33.24],['Ora e Njomzes',10.52],['Apple AirPods',12.62]].forEach(([n,b])=>addCat(t,n,'Mobile Phones',b));
      // Shopping
      addCat(t,'Shopping','Shopping',300.00);
      ;[['Clothing',50.00],['Home Appliances',0],['Home Furniture',50.00],['Medical',50.00],['School Equipment',0],['Books',20.00],['Amazon',100.00],['Temu',30.00],['Nyoki',0]].forEach(([n,b])=>addCat(t,n,'Shopping',b));
      // Other
      addCat(t,'Other','Other',300.00); [['Other',100.00],['Non-Sterling Transaction',0],['Jetes',200.00],['Holiday Spending',0],['Credit Card Payment',0]].forEach(([n,b])=>addCat(t,n,'Other',b));
      return t;
    };

    const addCat = (month, name, group, budget)=>{
      month.categories[name] = {group, budget: Number(budget)||0};
    };

    const setCat = (month, name, group, budget)=>{ addCat(month,name,group,budget); };
    const delCat = (month, name)=>{ delete month.categories[name]; };

    const addIncome = (month, name, amount)=>{ month.incomes.push({id:Utils.id(), name, amount:Number(amount)||0}); };
    const delIncome = (month, id)=>{ month.incomes = month.incomes.filter(x=>x.id!==id); };

    const addTx = (month, {date,desc,amount,category})=>{ month.transactions.push({id:Utils.id(),date,desc,amount:Number(amount)||0,category}); };
    const delTx = (month, id)=>{ month.transactions = month.transactions.filter(x=>x.id!==id); };

    const totals = (month)=>{
      const income = Utils.sum(month.incomes, x=>x.amount);
      const budgetPerCat = {}; const actualPerCat = {};
      for(const [name,meta] of Object.entries(month.categories)) budgetPerCat[name]=(meta.budget||0);
      for(const tx of month.transactions) actualPerCat[tx.category]=(actualPerCat[tx.category]||0)+tx.amount;
      const groups = {};
      for(const [cat,meta] of Object.entries(month.categories)){
        const g = meta.group||'Other';
        const b = budgetPerCat[cat]||0; const a = actualPerCat[cat]||0;
        const gg = groups[g] || {budget:0,actual:0}; gg.budget+=b; gg.actual+=a; groups[g]=gg;
      }
      const budgetTotal = Utils.sum(Object.values(budgetPerCat));
      const actualTotal = Utils.sum(Object.values(actualPerCat));
      return {income,budgetPerCat,actualPerCat,groups,budgetTotal,actualTotal,leftoverActual: income-actualTotal,leftoverBudget: income-budgetTotal};
    };

    return {emptyMonth,template,addCat,setCat,delCat,addIncome,delIncome,addTx,delTx,totals};
  })();

  // ===== UI Controller
  const UI = (()=>{
    const els = {
      headerMonth: document.getElementById('header-month'),
      leftoverPill: document.getElementById('leftover-pill'),
      monthPicker: document.getElementById('month-picker'),
      newMonth: document.getElementById('new-month'),
      duplicateMonth: document.getElementById('duplicate-month'),
      openMonth: document.getElementById('open-month'),
      exportMonth: document.getElementById('export-month'),
      exportYear: document.getElementById('export-year'),
      exportAll: document.getElementById('export-all'),
      importFile: document.getElementById('import-file'),

      // Tabs
      tabBudget: document.getElementById('tab-budget'),
      tabTx: document.getElementById('tab-transactions'),
      tabLearning: document.getElementById('tab-learning'),
      panelBudget: document.getElementById('panel-budget'),
      panelTx: document.getElementById('panel-transactions'),
      panelLearning: document.getElementById('panel-learning'),

      // Income
      incomeList: document.getElementById('income-list'),
      incomeName: document.getElementById('income-name'),
      incomeAmount: document.getElementById('income-amount'),
      addIncome: document.getElementById('add-income'),
      totalIncome: document.getElementById('total-income'),
      leftoverActual: document.getElementById('leftover-actual'),

      // Categories table
      catName: document.getElementById('cat-name'),
      catGroup: document.getElementById('cat-group'),
      catBudget: document.getElementById('cat-budget'),
      addCategory: document.getElementById('add-category'),
      resetTemplate: document.getElementById('reset-template'),
      collapseAll: document.getElementById('collapse-all'),
      expandAll: document.getElementById('expand-all'),
      catTable: document.getElementById('category-table').querySelector('tbody'),
      totBud: document.getElementById('tot-bud'),
      totAct: document.getElementById('tot-act'),
      totDiff: document.getElementById('tot-diff'),

      // Transactions
      txDate: document.getElementById('tx-date'),
      txDesc: document.getElementById('tx-desc'),
      txAmt: document.getElementById('tx-amt'),
      txCat: document.getElementById('tx-cat'),
      addTx: document.getElementById('add-tx'),
      txList: document.getElementById('tx-list'),
      predictHint: document.getElementById('predict-hint'),

      // Learning
      learnDesc: document.getElementById('learn-desc'),
      learnCat: document.getElementById('learn-cat'),
      learnAdd: document.getElementById('learn-add'),
      learnList: document.getElementById('learn-list'),

      // Charts
      barCategories: document.getElementById('bar-categories'),
      donutActual: document.getElementById('donut-actual'),
      donutBudget: document.getElementById('donut-budget'),
      barPerCat: document.getElementById('bar-percat')
    };

    let currentMonthKey = Utils.monthKey();

    // ---- init data if empty
    (function bootstrap(){
      if(Store.allMonths().length===0){
        const mk = Utils.monthKey(new Date());
        const month = Model.template();
        // Seed example incomes (can be edited)
        Model.addIncome(month,'Salary',4705.66);
        Model.addIncome(month,'Vala',212.28);
        Store.setMonth(mk, month);
      }
      currentMonthKey = Store.allMonths().slice(-1)[0] || Utils.monthKey();
      els.monthPicker.value = currentMonthKey;
    })();

    function loadMonth(mk){
      const month = Store.getMonth(mk);
      if(!month) return;
      currentMonthKey = mk; els.headerMonth.textContent = new Date(mk+'-01').toLocaleString(undefined,{month:'long',year:'numeric'});
      // populate incomes
      els.incomeList.innerHTML = '';
      month.incomes.forEach(x=> addIncomeRow(x));
      // populate categories
      renderCategories(month);
      // populate tx dropdown and list
      refreshCategoryDropdowns(month);
      renderTransactions(month);
      // refresh open-month select
      refreshMonthPicker();
      // charts + KPIs
      refreshKPIs();
    }

    function refreshMonthPicker(){
      els.openMonth.innerHTML = Store.allMonths().map(mk=>`<option value="${mk}" ${mk===currentMonthKey?'selected':''}>${new Date(mk+'-01').toLocaleString(undefined,{month:'short',year:'numeric'})}</option>`).join('');
    }

    function addIncomeRow(x){
      const row = document.createElement('div'); row.className='list-item';
      row.innerHTML = `<div><strong>${x.name}</strong><div><small>${Utils.fmt(x.amount)}</small></div></div>
                       <button data-id="${x.id}">Delete</button>`;
      row.querySelector('button').onclick = ()=>{ const m=Store.getMonth(currentMonthKey); Model.delIncome(m,x.id); Store.setMonth(currentMonthKey,m); loadMonth(currentMonthKey); };
      els.incomeList.appendChild(row);
    }

    function renderCategories(month){
      els.catTable.innerHTML='';
      const totals = Model.totals(Store.getMonth(currentMonthKey));
      const entries = Object.entries(month.categories);
      const byGroup = {};
      for(const [name,meta] of entries){ const g=meta.group||'Other'; (byGroup[g]=byGroup[g]||[]).push([name,meta]); }
      const groups = Object.keys(byGroup).sort();
      for(const g of groups){
        const gBud = totals.groups[g]?.budget||0; const gAct = totals.groups[g]?.actual||0; const gDiff = gBud - gAct; const gCls = gDiff>=0?'success':'danger';
        const collapsed = Store.isCollapsed(currentMonthKey,g); const icon = collapsed ? '▶' : '▼';
        const trh = document.createElement('tr'); trh.className='group-row';
        trh.innerHTML = `<td colspan="2"><button class="toggle" data-group="${g}" aria-label="toggle">${icon}</button><strong>${g}</strong></td>
                         <td class="right">${Utils.fmt(gBud)}</td>
                         <td class="right">${Utils.fmt(gAct)}</td>
                         <td class="right ${gCls}">${Utils.fmt(gDiff)}</td>
                         <td></td>`;
        trh.querySelector('button.toggle').onclick = (e)=>{ e.stopPropagation(); Store.toggleCollapsed(currentMonthKey,g); renderCategories(month); };
        els.catTable.appendChild(trh);
        const items = byGroup[g].sort((a,b)=> a[0].localeCompare(b[0]));
        for(const [name,meta] of items){
          const act = totals.actualPerCat[name]||0; const diff = (meta.budget||0) - act; const cls = diff>=0?'success':'danger';
          const tr = document.createElement('tr'); if(collapsed) tr.classList.add('hidden'); tr.dataset.cat=name; tr.dataset.group=g;
          tr.innerHTML = `<td></td>
                          <td>${name}</td>
                          <td class="right">${Utils.fmt(meta.budget||0)}</td>
                          <td class="right">${Utils.fmt(act)}</td>
                          <td class="right ${cls}">${Utils.fmt(diff)}</td>
                          <td class="right"><button data-act="edit">Edit</button> <button data-act="del">Del</button></td>`;
          tr.onclick = (e)=>{
            const actn = e.target?.dataset?.act; if(!actn) return;
            if(actn==='del'){ delete month.categories[name]; Store.setMonth(currentMonthKey,month); renderCategories(month); refreshKPIs(); refreshCategoryDropdowns(month); }
            if(actn==='edit'){ els.catName.value=name; els.catGroup.value=meta.group||''; els.catBudget.value=meta.budget||0; }
          };
          els.catTable.appendChild(tr);
        }
      }
      const t = Model.totals(month);
      els.totBud.textContent = Utils.fmt(t.budgetTotal);
      els.totAct.textContent = Utils.fmt(t.actualTotal);
      els.totDiff.textContent = Utils.fmt(t.budgetTotal - t.actualTotal);
    }

    function refreshCategoryDropdowns(month){
      const opts = Object.keys(month.categories).sort().map(c=>`<option>${c}</option>`).join('');
      els.txCat.innerHTML = `<option value="">— select —</option>`+opts;
      els.learnCat.innerHTML = opts;
    }

    function renderTransactions(month){
      els.txList.innerHTML='';
      const items = month.transactions.slice().sort((a,b)=> a.date.localeCompare(b.date));
      for(const t of items){
        const row = document.createElement('div'); row.className='list-item';
        row.innerHTML = `<div><strong>${t.desc}</strong><div><small>${t.date} • ${t.category||'Uncategorised'}</small></div></div>
                         <div class="right"><div>${Utils.fmt(t.amount)}</div><small><button data-id="${t.id}">Delete</button></small></div>`;
        row.querySelector('button').onclick = ()=>{ const m=Store.getMonth(currentMonthKey); Model.delTx(m,t.id); Store.setMonth(currentMonthKey,m); loadMonth(currentMonthKey); };
        els.txList.appendChild(row);
      }
      refreshKPIs();
    }

    function refreshKPIs(){
      const month = Store.getMonth(currentMonthKey);
      const t = Model.totals(month);
      els.totalIncome.textContent = Utils.fmt(t.income);
      els.leftoverActual.textContent = Utils.fmt(t.leftoverActual);
      els.leftoverPill.textContent = `Left Over ${Utils.fmt(t.leftoverActual)}`;

      // Charts
      const groups = Object.keys(t.groups).sort();
      const budgetSeries = groups.map(g=>t.groups[g].budget);
      const actualSeries = groups.map(g=>t.groups[g].actual);
      Charts.bar(els.barCategories, groups, [budgetSeries, actualSeries]);
      Charts.donut(els.donutBudget, Object.fromEntries(groups.map(g=>[g,t.groups[g].budget])));
      Charts.donut(els.donutActual, Object.fromEntries(groups.map(g=>[g,t.groups[g].actual])));

      // Per-category bar
      const cats = Object.keys(month.categories).sort();
      const b2 = cats.map(c=>month.categories[c].budget||0);
      const a2 = cats.map(c=>t.actualPerCat[c]||0);
      Charts.bar(els.barPerCat, cats, [b2,a2]);
    }

    // ---- Event wiring
    els.addIncome.onclick = ()=>{
      const name = els.incomeName.value.trim() || 'Income';
      const amt = parseFloat(els.incomeAmount.value||'0');
      const m = Store.getMonth(currentMonthKey); Model.addIncome(m,name,amt); Store.setMonth(currentMonthKey,m);
      els.incomeName.value=''; els.incomeAmount.value=''; loadMonth(currentMonthKey);
    };

    els.addCategory.onclick = ()=>{
      const name = els.catName.value.trim(); const group = els.catGroup.value.trim()||'Other'; const bud = parseFloat(els.catBudget.value||'0');
      if(!name) return;
      const m = Store.getMonth(currentMonthKey); Model.setCat(m,name,group,bud); Store.setMonth(currentMonthKey,m);
      els.catName.value=''; els.catGroup.value=''; els.catBudget.value=''; loadMonth(currentMonthKey);
    };

    els.resetTemplate.onclick = ()=>{
      if(!confirm('Replace current month categories with default template?')) return;
      const base = Model.template(); const m = Store.getMonth(currentMonthKey);
      m.categories = base.categories; Store.setMonth(currentMonthKey,m); loadMonth(currentMonthKey);
    };

    // Collapse/Expand all groups
    els.collapseAll.onclick = ()=>{
      const m = Store.getMonth(currentMonthKey);
      const groups = [...new Set(Object.values(m.categories).map(x=>x.group||'Other'))];
      Store.setAllCollapsed(currentMonthKey, groups, true); renderCategories(m);
    };
    els.expandAll.onclick = ()=>{
      const m = Store.getMonth(currentMonthKey);
      const groups = [...new Set(Object.values(m.categories).map(x=>x.group||'Other'))];
      Store.setAllCollapsed(currentMonthKey, groups, false); renderCategories(m);
    };

    // Transaction prediction
    els.txDesc.addEventListener('input', ()=>{
      const m = Store.getMonth(currentMonthKey); const cats = Object.keys(m.categories);
      const guess = Predictor.predict(els.txDesc.value, cats);
      els.predictHint.textContent = 'Prediction: '+(guess||'–');
      if(guess){ els.txCat.value = guess; }
    });

    els.addTx.onclick = ()=>{
      const date = els.txDate.value || new Date().toISOString().slice(0,10);
      const desc = els.txDesc.value.trim(); const amt = parseFloat(els.txAmt.value||'0'); const cat = els.txCat.value;
      const m = Store.getMonth(currentMonthKey); Model.addTx(m,{date,desc,amount:amt,category:cat}); Store.setMonth(currentMonthKey,m);
      Predictor.learn(desc,cat);
      els.txDesc.value=''; els.txAmt.value=''; renderTransactions(m);
    };

    // Learning panel
    els.learnAdd.onclick = ()=>{ Predictor.learn(els.learnDesc.value, els.learnCat.value); els.learnDesc.value=''; renderLearnList(); };

    function renderLearnList(){
      const map = Store.mapping();
      els.learnList.innerHTML = '';
      for(const [k,v] of Object.entries(map.exact)){
        const row = document.createElement('div'); row.className='list-item';
        row.innerHTML = `<div><strong>${k}</strong><div><small>${v}</small></div></div>`;
        els.learnList.appendChild(row);
      }
    }

    // Month controls
    els.newMonth.onclick = ()=>{
      const mk = els.monthPicker.value || Utils.monthKey();
      if(Store.getMonth(mk)) { alert('Month already exists. Use Duplicate if needed.'); return; }
      const month = Model.template(); Store.setMonth(mk, month); loadMonth(mk);
    };
    els.duplicateMonth.onclick = ()=>{
      const months = Store.allMonths(); if(months.length<1) return;
      const prev = months[months.length-1]; const mk = els.monthPicker.value || Utils.monthKey();
      const dup = Utils.clone(Store.getMonth(prev)); dup.transactions=[]; // carry categories & incomes, not tx
      Store.setMonth(mk, dup); loadMonth(mk);
    };
    els.openMonth.onchange = (e)=> loadMonth(e.target.value);

    // Export/Import
    function download(name, data){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); a.download=name; a.click(); }
    els.exportMonth.onclick = ()=>{
      const mk=currentMonthKey; const data = Store.exportMonths(k=>k===mk); download(`budget-${mk}.json`, data);
    };
    els.exportYear.onclick = ()=>{
      const year = (currentMonthKey||Utils.monthKey()).slice(0,4);
      const data = Store.exportMonths(k=>k.startsWith(year+'-')); download(`budget-${year}.json`, data);
    };
    els.exportAll.onclick = ()=>{ const data = Store.exportMonths(); download(`budget-all.json`, data); };
    els.importFile.onchange = (e)=>{
      const file = e.target.files[0]; if(!file) return; const r=new FileReader();
      r.onload = ()=>{ try{ Store.importData(JSON.parse(r.result)); loadMonth(currentMonthKey); alert('Import completed.'); }catch{ alert('Invalid JSON'); } };
      r.readAsText(file);
    };

    // Tabs
    function selectTab(key){
      const map = {budget:[els.tabBudget,els.panelBudget], tx:[els.tabTx,els.panelTx], learn:[els.tabLearning,els.panelLearning]};
      for(const [k,[btn,pan]] of Object.entries(map)){ const on = (k===key); btn.setAttribute('aria-selected',on); pan.classList.toggle('hidden',!on); }
    }
    els.tabBudget.onclick = ()=>selectTab('budget');
    els.tabTx.onclick = ()=>selectTab('tx');
    els.tabLearning.onclick = ()=>{ selectTab('learn'); renderLearnList(); };

    // Initial load
    loadMonth(currentMonthKey);
  })();
  </script>
</body>
</html>
